import{u as U,j as e,s as j}from"./index-DHEotZcm.js";import{h as V,u as H,c,d as K,i as B,L as G}from"./vendor-WYr585uA.js";import"./supabase-B76hXWPk.js";function Y(){const{taleId:d}=V(),h=H(),[l,L]=c.useState(()=>{const s=h.state?.tale;if(!s)return null;const r=s.cover_image||s.cover_url;let a=r;return r&&r.includes("wixstatic")?a=null:r&&!r.startsWith("http")&&(a=`https://gmunwpptyhwiiffcbhcq.supabase.co/storage/v1/object/public/${r.split("/").map(t=>encodeURIComponent(t)).join("/")}`),{...s,cover:a,description:s.synopsis,credits:s.credits||{creative:[],voices:[]},chapters:[]}}),q=h.state?.tale&&(h.state.tale.cover_image||h.state.tale.cover_url||"").includes("wixstatic"),[D,g]=c.useState(!h.state?.tale||q),[b,x]=c.useState(!1),[T,N]=c.useState(5),[C,z]=c.useState(null),[n,A]=c.useState(!1),[y,f]=c.useState(!1),[J,k]=c.useState(!1),{user:p}=U(),u=K();if(c.useEffect(()=>{if(!d){g(!1);return}async function s(){try{const{data:r,error:a}=await j.from("tales").select("*").eq("slug",d).single();if(a||!r){console.error("Tale not found:",a),u("/hub");return}const{data:t,error:o}=await j.from("chapters").select("*").eq("tale_id",r.id).order("chapter_number",{ascending:!0});o&&console.error("Error fetching chapters:",o);const _=r.cover_image||r.cover_url,I={...r,cover:_&&!_.startsWith("http")?`https://gmunwpptyhwiiffcbhcq.supabase.co/storage/v1/object/public/${_.split("/").map(F=>encodeURIComponent(F)).join("/")}`:_,description:r.synopsis,credits:r.credits||{creative:[],voices:[]},chapters:t||[]};L(I),window.innerWidth>768&&N(I.chapters.length)}catch(r){console.error("Error in fetchTaleData:",r),u("/hub")}finally{g(!1)}}s()},[d,u]),c.useEffect(()=>{async function s(){if(!l?.id||!p){f(!1);return}k(!0);const{data:r,error:a}=await j.from("purchases").select("id").eq("tale_id",l.id).eq("user_id",p.id).limit(1);a?(console.error("Error checking purchase:",a),f(!1)):f(!!r?.length),k(!1)}s()},[l?.id,p]),c.useEffect(()=>{const s=()=>{const r=window.innerWidth>768;A(r),r&&l&&N(l.chapters.length)};return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[l]),c.useEffect(()=>{if(!b)return;const s=r=>{r.key==="Escape"&&x(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[b]),D)return e.jsx("div",{className:"page pre-hub-page",style:{display:"flex",justifyContent:"center",alignItems:"center"},children:"Chargement du Tale..."});if(!l)return null;const{title:w,subtitle:M,description:R,cover:E,credits:i,chapters:m}=l,W=n?m:m.slice(0,T),v=(s,r=!1)=>{if(s.is_premium&&!y){p?window.alert("Achetez ce Tale pour accéder aux chapitres premium."):window.alert("Connexion requise pour accéder aux chapitres premium.");return}n||r?(S(),u(`/lecture/${d}/${s.id}`)):z(C===s.id?null:s.id)},$=()=>x(!0),P=()=>x(!1),S=()=>{document.fullscreenElement||document.documentElement.requestFullscreen().catch(s=>{console.log(`Error attempting to enable fullscreen: ${s.message}`)})};return e.jsxs("div",{className:"page pre-hub-page page--fade",children:[e.jsx("div",{className:"pre-hub",children:e.jsxs("div",{className:"pre-hub__inner",children:[e.jsx("div",{className:"pre-hub__hero",children:e.jsxs("div",{className:"pre-hub__hero-grid",children:[e.jsx("div",{className:"pre-hub__media",children:e.jsx("div",{className:"pre-hub__poster",children:e.jsx("img",{src:E,alt:w,loading:"eager",onError:s=>{s.target.src="https://placehold.co/600x900/1a1a1a/ffffff?text=No+Cover"}})})}),e.jsxs("div",{className:"pre-hub__hero-text",children:[e.jsx("h1",{className:"pre-hub__novel-title stagger-item delay-2",children:w}),e.jsx("p",{className:"pre-hub__lead stagger-item delay-3",children:R}),m.length>0&&e.jsx(G,{to:`/lecture/${d}/${m[0].id}`,className:"pre-hub__cta stagger-item delay-4",onClick:S,children:"Commencer l'écoute"}),e.jsx("div",{className:"pre-hub__credits-section stagger-item delay-4",children:n?e.jsxs("div",{className:"pre-hub__credits-grid-desktop",children:[i.creative&&i.creative.map((s,r)=>e.jsxs("div",{className:"pre-hub__credit-card-desktop",children:[e.jsx("h3",{className:"pre-hub__credit-head",children:s.title==="Production"?"Illustration":s.title}),e.jsx("ul",{className:"pre-hub__credit-lines",children:s.people.map((a,t)=>e.jsxs("li",{className:"pre-hub__credit-line",children:[e.jsx("span",{className:"pre-hub__credit-name",children:a.name}),e.jsx("span",{className:"pre-hub__credit-role",children:a.role})]},t))})]},r)),e.jsxs("div",{className:"pre-hub__credit-card-desktop",children:[e.jsx("h3",{className:"pre-hub__credit-head",children:"Comédiens"}),e.jsx("ul",{className:"pre-hub__credit-lines",children:i.voices&&i.voices.slice(0,3).map((s,r)=>e.jsxs("li",{className:"pre-hub__credit-line",children:[e.jsx("span",{className:"pre-hub__credit-name",children:s.name}),e.jsx("span",{className:"pre-hub__credit-role",children:s.role})]},r))}),e.jsx("button",{className:"pre-hub__credit-more-link",onClick:$,children:"Voir tous les talents"})]})]}):e.jsxs("div",{className:"pre-hub__credit-stack",onClick:$,children:[e.jsx("div",{className:"pre-hub__credit-stack__head",children:e.jsx("h3",{className:"pre-hub__credit-head",children:"Crédits"})}),e.jsx("ul",{className:"pre-hub__credit-lines",children:i.creative&&i.creative.slice(0,2).map(s=>s.people.map((r,a)=>e.jsxs("li",{className:"pre-hub__credit-line",children:[e.jsx("span",{className:"pre-hub__credit-name",children:r.name}),e.jsx("span",{className:"pre-hub__credit-role",children:r.role})]},`${s.title}-${a}`)))}),e.jsx("div",{className:"pre-hub__credit-more-container",children:e.jsx("span",{className:"pre-hub__credit-more",children:"Afficher plus"})})]})})]})]})}),e.jsx("section",{className:"pre-hub__pane pre-hub__pane--chapters",children:e.jsx("div",{className:"pre-hub__chapter-list",children:W.map(s=>{const r=C===s.id,a=s.is_premium&&!y;let t=s.cover_image||E;return t&&!t.startsWith("http")&&(t=`https://gmunwpptyhwiiffcbhcq.supabase.co/storage/v1/object/public/${t.split("/").map(o=>encodeURIComponent(o)).join("/")}`),e.jsxs("article",{className:`pre-hub__chapter-card pre-hub__chapter-card--list ${r?"expanded":""} ${a?"chapter-locked":""}`,onClick:()=>v(s),children:[e.jsx("div",{className:"pre-hub__chapter-thumb",style:{backgroundImage:`url('${t}')`},onClick:o=>{n||(o.stopPropagation(),v(s,!0))},children:n&&e.jsx("span",{className:"pre-hub__chapter-badge",children:s.chapter_number})}),e.jsxs("div",{className:"pre-hub__chapter-content",children:[e.jsxs("div",{className:"pre-hub__chapter-header-mobile",children:[e.jsxs("div",{className:"pre-hub__chapter-texts",children:[e.jsx("p",{className:"pre-hub__chapter-title",children:s.title}),s.is_premium&&e.jsx("span",{style:{color:"#f59e0b",fontSize:"0.85rem",marginLeft:"8px"},children:"Premium"})]}),!n&&e.jsxs("span",{className:"pre-hub__chapter-badge pre-hub__chapter-badge--mobile",children:["#",s.chapter_number]})]}),e.jsxs("div",{className:`pre-hub__chapter-details ${n||r?"visible":""}`,children:[e.jsx("p",{className:"pre-hub__chapter-desc",children:s.description||"Aucune description disponible."}),!n&&a&&e.jsx("button",{className:"pre-hub__chapter-play-btn",onClick:o=>{o.stopPropagation(),v(s)},style:{backgroundColor:"#f59e0b",color:"#0a0a0a"},children:p?"Acheter":"Connexion requise"})]})]})]},s.id)})})})]})}),b&&B.createPortal(e.jsx("div",{className:"credits-overlay",onClick:P,children:e.jsxs("div",{className:"credits-overlay__panel",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"credits-overlay__head",children:[e.jsx("h2",{className:"credits-overlay__title",children:"Crédits complets"}),e.jsx("button",{className:"credits-overlay__close",onClick:P,children:"Fermer"})]}),e.jsx("div",{className:"credits-overlay__grid",children:i.creative&&i.creative.map((s,r)=>e.jsxs("div",{className:"credits-overlay__card",children:[e.jsx("h3",{className:"credits-overlay__card-title",children:s.title}),e.jsx("ul",{children:s.people.map((a,t)=>e.jsxs("li",{children:[a.name," - ",a.role]},t))})]},r))}),e.jsxs("div",{className:"credits-overlay__voices",children:[e.jsx("h3",{children:"Comédiens"}),e.jsx("ul",{children:i.voices&&i.voices.map((s,r)=>e.jsxs("li",{children:[s.name," - ",s.role]},r))})]})]})}),document.body)]})}export{Y as default};
