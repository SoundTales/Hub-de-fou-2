import{u as A,j as e,s as j}from"./index-Cma2b9qH.js";import{h as R,u as V,c as i,d as W,i as F,L as H}from"./vendor-WYr585uA.js";import"./supabase-B76hXWPk.js";function O(){const{taleId:o}=R(),d=V(),[l,S]=i.useState(d.state?.tale?{...d.state.tale,cover:d.state.tale.cover_url,description:d.state.tale.synopsis,credits:d.state.tale.credits||{creative:[],voices:[]},chapters:[]}:null),[$,v]=i.useState(!d.state?.tale),[m,_]=i.useState(!1),[D,f]=i.useState(5),[N,I]=i.useState(null),[n,T]=i.useState(!1),[g,x]=i.useState(!1),[K,k]=i.useState(!1),{user:h}=A(),p=W();if(i.useEffect(()=>{if(!o){v(!1);return}async function s(){try{const{data:r,error:a}=await j.from("tales").select("*").eq("slug",o).single();if(a||!r){console.error("Tale not found:",a),p("/hub");return}const{data:c,error:P}=await j.from("chapters").select("*").eq("tale_id",r.id).order("chapter_number",{ascending:!0});P&&console.error("Error fetching chapters:",P);const L={...r,cover:r.cover_url,description:r.synopsis,credits:r.credits||{creative:[],voices:[]},chapters:c||[]};S(L),window.innerWidth>768&&f(L.chapters.length)}catch(r){console.error("Error in fetchTaleData:",r),p("/hub")}finally{v(!1)}}s()},[o,p]),i.useEffect(()=>{async function s(){if(!l?.id||!h){x(!1);return}k(!0);const{data:r,error:a}=await j.from("purchases").select("id").eq("tale_id",l.id).eq("user_id",h.id).limit(1);a?(console.error("Error checking purchase:",a),x(!1)):x(!!r?.length),k(!1)}s()},[l?.id,h]),i.useEffect(()=>{const s=()=>{const r=window.innerWidth>768;T(r),r&&l&&f(l.chapters.length)};return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[l]),i.useEffect(()=>{if(!m)return;const s=r=>{r.key==="Escape"&&_(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[m]),$)return e.jsx("div",{className:"page pre-hub-page",style:{display:"flex",justifyContent:"center",alignItems:"center"},children:"Chargement du Tale..."});if(!l)return null;const{title:y,subtitle:B,description:q,cover:C,credits:t,chapters:u}=l,z=n?u:u.slice(0,D),b=(s,r=!1)=>{if(s.is_premium&&!g){h?window.alert("Achetez ce Tale pour accéder aux chapitres premium."):window.alert("Connexion requise pour accéder aux chapitres premium.");return}n||r?p(`/lecture/${o}/${s.id}`):I(N===s.id?null:s.id)},w=()=>_(!0),E=()=>_(!1);return e.jsxs("div",{className:"page pre-hub-page page--fade",children:[e.jsx("div",{className:"pre-hub",children:e.jsxs("div",{className:"pre-hub__inner",children:[e.jsx("div",{className:"pre-hub__hero",children:e.jsxs("div",{className:"pre-hub__hero-grid",children:[e.jsx("div",{className:"pre-hub__media",children:e.jsx("div",{className:"pre-hub__poster",children:e.jsx("img",{src:C,alt:y,loading:"eager",onError:s=>{s.target.src="https://placehold.co/600x900/1a1a1a/ffffff?text=No+Cover"}})})}),e.jsxs("div",{className:"pre-hub__hero-text",children:[e.jsx("h1",{className:"pre-hub__novel-title stagger-item delay-2",children:y}),e.jsx("p",{className:"pre-hub__lead stagger-item delay-3",children:q}),u.length>0&&e.jsx(H,{to:`/lecture/${o}/${u[0].id}`,className:"pre-hub__cta stagger-item delay-4",children:"Commencer l'écoute"}),e.jsx("div",{className:"pre-hub__credits-section stagger-item delay-4",children:n?e.jsxs("div",{className:"pre-hub__credits-grid-desktop",children:[t.creative&&t.creative.map((s,r)=>e.jsxs("div",{className:"pre-hub__credit-card-desktop",children:[e.jsx("h3",{className:"pre-hub__credit-head",children:s.title==="Production"?"Illustration":s.title}),e.jsx("ul",{className:"pre-hub__credit-lines",children:s.people.map((a,c)=>e.jsxs("li",{className:"pre-hub__credit-line",children:[e.jsx("span",{className:"pre-hub__credit-name",children:a.name}),e.jsx("span",{className:"pre-hub__credit-role",children:a.role})]},c))})]},r)),e.jsxs("div",{className:"pre-hub__credit-card-desktop",children:[e.jsx("h3",{className:"pre-hub__credit-head",children:"Comédiens"}),e.jsx("ul",{className:"pre-hub__credit-lines",children:t.voices&&t.voices.slice(0,3).map((s,r)=>e.jsxs("li",{className:"pre-hub__credit-line",children:[e.jsx("span",{className:"pre-hub__credit-name",children:s.name}),e.jsx("span",{className:"pre-hub__credit-role",children:s.role})]},r))}),e.jsx("button",{className:"pre-hub__credit-more-link",onClick:w,children:"Voir tous les talents"})]})]}):e.jsxs("div",{className:"pre-hub__credit-stack",onClick:w,children:[e.jsx("div",{className:"pre-hub__credit-stack__head",children:e.jsx("h3",{className:"pre-hub__credit-head",children:"Crédits"})}),e.jsx("ul",{className:"pre-hub__credit-lines",children:t.creative&&t.creative.slice(0,2).map(s=>s.people.map((r,a)=>e.jsxs("li",{className:"pre-hub__credit-line",children:[e.jsx("span",{className:"pre-hub__credit-name",children:r.name}),e.jsx("span",{className:"pre-hub__credit-role",children:r.role})]},`${s.title}-${a}`)))}),e.jsx("div",{className:"pre-hub__credit-more-container",children:e.jsx("span",{className:"pre-hub__credit-more",children:"Afficher plus"})})]})})]})]})}),e.jsx("section",{className:"pre-hub__pane pre-hub__pane--chapters",children:e.jsx("div",{className:"pre-hub__chapter-list",children:z.map(s=>{const r=N===s.id,a=s.is_premium&&!g;return e.jsxs("article",{className:`pre-hub__chapter-card pre-hub__chapter-card--list ${r?"expanded":""} ${a?"chapter-locked":""}`,onClick:()=>b(s),children:[e.jsx("div",{className:"pre-hub__chapter-thumb",style:{backgroundImage:`url('${C}')`},onClick:c=>{n||(c.stopPropagation(),b(s,!0))},children:n&&e.jsx("span",{className:"pre-hub__chapter-badge",children:s.chapter_number})}),e.jsxs("div",{className:"pre-hub__chapter-content",children:[e.jsxs("div",{className:"pre-hub__chapter-header-mobile",children:[e.jsxs("div",{className:"pre-hub__chapter-texts",children:[e.jsx("p",{className:"pre-hub__chapter-title",children:s.title}),s.is_premium&&e.jsx("span",{style:{color:"#f59e0b",fontSize:"0.85rem",marginLeft:"8px"},children:"Premium"})]}),!n&&e.jsxs("span",{className:"pre-hub__chapter-badge pre-hub__chapter-badge--mobile",children:["#",s.chapter_number]})]}),e.jsxs("div",{className:`pre-hub__chapter-details ${n||r?"visible":""}`,children:[e.jsx("p",{className:"pre-hub__chapter-desc",children:s.description||"Aucune description disponible."}),!n&&a&&e.jsx("button",{className:"pre-hub__chapter-play-btn",onClick:c=>{c.stopPropagation(),b(s)},style:{backgroundColor:"#f59e0b",color:"#0a0a0a"},children:h?"Acheter":"Connexion requise"})]})]})]},s.id)})})})]})}),m&&F.createPortal(e.jsx("div",{className:"credits-overlay",onClick:E,children:e.jsxs("div",{className:"credits-overlay__panel",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"credits-overlay__head",children:[e.jsx("h2",{className:"credits-overlay__title",children:"Crédits complets"}),e.jsx("button",{className:"credits-overlay__close",onClick:E,children:"Fermer"})]}),e.jsx("div",{className:"credits-overlay__grid",children:t.creative&&t.creative.map((s,r)=>e.jsxs("div",{className:"credits-overlay__card",children:[e.jsx("h3",{className:"credits-overlay__card-title",children:s.title}),e.jsx("ul",{children:s.people.map((a,c)=>e.jsxs("li",{children:[a.name," - ",a.role]},c))})]},r))}),e.jsxs("div",{className:"credits-overlay__voices",children:[e.jsx("h3",{children:"Comédiens"}),e.jsx("ul",{children:t.voices&&t.voices.map((s,r)=>e.jsxs("li",{children:[s.name," - ",s.role]},r))})]})]})}),document.body)]})}export{O as default};
