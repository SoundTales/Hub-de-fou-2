import{u as z,j as r,s as L}from"./index-Cma2b9qH.js";import{h as R,c as n,L as m}from"./vendor-WYr585uA.js";import{c as $}from"./createLucideIcon-eAH5ksrC.js";import"./supabase-B76hXWPk.js";const _=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],g=$("arrow-left",_),x=({onVisible:i,children:c})=>{const o=n.useRef(null),[l,h]=n.useState(!1);return n.useEffect(()=>{const u=new IntersectionObserver(([d])=>{d.isIntersecting&&!l&&(i(),h(!0))},{threshold:.5});return o.current&&u.observe(o.current),()=>u.disconnect()},[l,i]),r.jsx("div",{ref:o,children:c})};function I(){const{taleId:i,chapterId:c}=R(),[o,l]=n.useState(null),[h,u]=n.useState(!1),[d,b]=n.useState(null),[v,j]=n.useState(!0),{user:w}=z();n.useEffect(()=>{async function e(){try{const{data:t,error:s}=await L.from("chapters").select("*").eq("id",c).single();if(s||!t)throw console.error("DB Error:",s),new Error("Chapitre introuvable ou accÃ¨s refusÃ©.");if(t.is_premium&&!w)throw new Error("Connexion ou achat requis pour ce chapitre premium.");let a=t.content;if(!a&&t.content_url){const f=await fetch(t.content_url);if(!f.ok)throw new Error("Erreur lors du tÃ©lÃ©chargement du contenu.");a=await f.json()}if(!a)throw new Error("Contenu du chapitre vide ou manquant.");l(a)}catch(t){console.error(t),b(t.message||"Une erreur est survenue.")}finally{j(!1)}}c&&e()},[c]);const k=e=>o?.meta?.characters?o.meta.characters[e]||{name:e,color:"#fff"}:{name:e,color:"#fff"},p=(e,t)=>{if(!o?.meta?.basePaths)return t;const s=o.meta.basePaths;if(e==="voice")return s.voices+t;if(e==="music"){const a=o.audioRegistry?.tracks?.[t]||t;return s.music+a}if(e==="sfx"){const a=o.audioRegistry?.sfx?.[t]||t;return s.sfx+a}return t},y=()=>{console.log("Audio context unlocked"),u(!0)},N=(e,t)=>{console.log(`ðŸ—£ï¸ VOIX [${e}]: ${t}`)},C=e=>{const t=p("sfx",e);console.log(`ðŸ’¥ SFX: ${t}`)},E=(e,t)=>{const s=p("music",t);console.log(`ðŸŽµ MUSIC [${e}]: ${s}`)},S=e=>{console.log(`ðŸ’¾ Checkpoint: ${e}`)};return v?r.jsx("div",{className:"liseuse-loading",children:"Chargement du rÃ©cit..."}):d?r.jsxs("div",{className:"liseuse-error",children:[r.jsx("p",{children:d}),r.jsx(m,{to:`/tale/${i}`,className:"back-link",children:"Retour au Tale"})]}):o?h?r.jsxs("div",{className:"liseuse-container page page--zoom",children:[r.jsxs(m,{to:`/tale/${i}`,className:"liseuse-back-nav",children:[r.jsx(g,{size:20})," Quitter"]}),r.jsx("div",{className:"liseuse-content",children:o.blocks.map((e,t)=>{switch(e.type){case"text":return r.jsx("p",{className:"block-text",children:e.content},t);case"dialogue":const s=k(e.charId||e.character),a=p("voice",e.voiceFile||e.audioSrc);return r.jsxs("div",{className:"block-dialogue",style:{borderLeftColor:s.color},onClick:()=>N(s.name,a),children:[r.jsx("span",{className:"char-name",style:{color:s.color},children:s.name}),r.jsxs("p",{children:["Â« ",e.content," Â»"]})]},t);case"sfx_cue":return r.jsx(x,{onVisible:()=>C(e.sfxId),children:r.jsx("div",{className:"debug-trigger",children:"âš¡"})},t);case"music_cue":return r.jsx(x,{onVisible:()=>E(e.action,e.trackId),children:r.jsx("div",{className:"debug-trigger",children:"ðŸŽµ"})},t);case"checkpoint":return S(e.id),null;default:return null}})}),r.jsx("style",{children:`
        .liseuse-container { max-width: 800px; margin: 0 auto; padding: 40px 20px 150px 20px; color: #eee; min-height: 100vh; background-color: #111; position: relative; }
        .liseuse-back-nav { position: fixed; top: 20px; left: 20px; color: rgba(255,255,255,0.5); text-decoration: none; display: flex; align-items: center; gap: 8px; z-index: 50; transition: color 0.2s; }
        .liseuse-back-nav:hover { color: white; }
        .block-text { font-size: 1.1rem; line-height: 1.6; margin-bottom: 1.5rem; color: #ccc; font-family: 'Georgia', serif; }
        
        .block-dialogue {
          background: rgba(255,255,255,0.05);
          border-left: 4px solid #fff; /* Sera Ã©crasÃ© par le style inline */
          padding: 1rem; margin: 2rem 0; cursor: pointer; border-radius: 0 8px 8px 0;
          transition: background 0.2s;
        }
        .block-dialogue:hover { background: rgba(255,255,255,0.1); }
        .char-name { font-weight: bold; font-size: 0.8rem; text-transform: uppercase; display: block; margin-bottom: 5px;}
        
        .debug-trigger { font-size: 0.6rem; color: #333; text-align: center; padding: 2px; opacity: 0.2; }
        .liseuse-error { color: #ff6b6b; text-align: center; margin-top: 50px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .liseuse-loading { text-align: center; margin-top: 50px; color: #888; }
        .back-link { color: white; text-decoration: underline; }
      `})]}):r.jsxs("div",{className:"start-screen",children:[r.jsxs(m,{to:`/tale/${i}`,className:"absolute-back-btn",children:[r.jsx(g,{})," Retour"]}),r.jsx("div",{className:"cover-container",children:r.jsx("img",{src:o.meta.coverImage||"https://placehold.co/400x600/1a1a1a/white?text=No+Cover",alt:"Cover",className:"cover-image"})}),r.jsx("h1",{className:"chapter-title",children:o.meta.title}),r.jsx("button",{className:"start-btn",onClick:y,children:"COMMENCER LA LECTURE"}),r.jsx("style",{children:`
          .start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background-color: #0a0a0a; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
          .cover-container { width: 100%; max-width: 300px; aspect-ratio: 2/3; margin-bottom: 2rem; box-shadow: 0 0 30px rgba(0,0,0,0.8); overflow: hidden; border-radius: 8px; }
          .cover-image { width: 100%; height: 100%; object-fit: cover; }
          .chapter-title { color: white; text-align: center; margin-bottom: 2rem; font-size: 1.5rem; }
          .start-btn { background: #00d2ff; color: #000; border: none; padding: 1rem 2rem; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; text-transform: uppercase; transition: transform 0.2s; }
          .start-btn:hover { transform: scale(1.05); background: #fff; }
          .absolute-back-btn { position: absolute; top: 20px; left: 20px; color: white; text-decoration: none; display: flex; align-items: center; gap: 8px; opacity: 0.7; transition: opacity 0.2s; }
          .absolute-back-btn:hover { opacity: 1; }
        `})]}):null}export{I as default};
