import{u as G,j as e,s as N}from"./index-DHGFovfL.js";import{h as J,u as M,c as t,d as O,L as A,i as Q}from"./vendor-WYr585uA.js";import"./supabase-B76hXWPk.js";function re(){const{taleId:d}=J(),h=M(),[x,m]=t.useState(null),[y,C]=t.useState(null),[l,z]=t.useState(()=>{const s=h.state?.tale;if(!s)return null;const r=s.cover_image||s.cover_url;let a=r;return r&&r.includes("wixstatic")?a=null:r&&!r.startsWith("http")&&(a=`https://gmunwpptyhwiiffcbhcq.supabase.co/storage/v1/object/public/${r.split("/").map(c=>encodeURIComponent(c)).join("/")}`),{...s,cover:a,description:s.synopsis,credits:s.credits||{creative:[],voices:[]},chapters:[]}}),W=h.state?.tale&&(h.state.tale.cover_image||h.state.tale.cover_url||"").includes("wixstatic"),[F,k]=t.useState(!h.state?.tale||W),[p,g]=t.useState(!1),[U,w]=t.useState(5),[E,B]=t.useState(null),[n,V]=t.useState(!1),[$,v]=t.useState(!1),[X,L]=t.useState(!1),{user:u}=G(),S=O();if(t.useEffect(()=>{if(!d){k(!1);return}async function s(){try{m(null);const{data:r,error:a}=await N.from("tales").select("*").eq("slug",d).single();if(a||!r){console.error("Tale not found:",a),m("Impossible de trouver ce Tale ou il n'est pas disponible.");return}const{data:c,error:o}=await N.from("chapters").select("*").eq("tale_id",r.id).order("chapter_number",{ascending:!0});o&&(console.error("Error fetching chapters:",o),m("Les chapitres de ce Tale sont indisponibles pour le moment."));const b=r.cover_image||r.cover_url,R={...r,cover:b&&!b.startsWith("http")?`https://gmunwpptyhwiiffcbhcq.supabase.co/storage/v1/object/public/${b.split("/").map(j=>encodeURIComponent(j)).join("/")}`:b,description:r.synopsis,credits:r.credits||{creative:[],voices:[]},chapters:c||[]};z(R),window.innerWidth>768&&w(R.chapters.length)}catch(r){console.error("Error in fetchTaleData:",r),m("Impossible de charger ce Tale pour le moment.")}finally{k(!1)}}s()},[d,S]),t.useEffect(()=>{async function s(){if(!l?.id||!u){v(!1);return}L(!0);const{data:r,error:a}=await N.from("purchases").select("id").eq("tale_id",l.id).eq("user_id",u.id).limit(1);a?(console.error("Error checking purchase:",a),v(!1)):v(!!r?.length),L(!1)}s()},[l?.id,u]),t.useEffect(()=>{const s=()=>{const r=window.innerWidth>768;V(r),r&&l&&w(l.chapters.length)};return s(),window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[l]),t.useEffect(()=>{if(!p)return;const s=r=>{r.key==="Escape"&&g(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[p]),t.useEffect(()=>(p?document.body.classList.add("no-scroll"):document.body.classList.remove("no-scroll"),()=>{document.body.classList.remove("no-scroll")}),[p]),F)return e.jsx("div",{className:"page pre-hub-page",style:{display:"flex",justifyContent:"center",alignItems:"center"},children:"Chargement du Tale..."});if(!l)return e.jsxs("div",{className:"page pre-hub-page",style:{padding:"120px 20px",textAlign:"center"},children:[e.jsx("p",{style:{marginBottom:"16px"},children:x||"Ce Tale est introuvable ou temporairement indisponible."}),e.jsx(A,{to:"/hub",className:"pre-hub__cta",children:"Retour au catalogue"})]});const{title:I,subtitle:Y,description:H,cover:P,credits:i,chapters:_}=l,K=n?_:_.slice(0,U),f=(s,r=!1)=>{if(s.is_premium&&!$){C(u?"Achetez ce Tale pour accéder aux chapitres premium.":"Connexion requise pour accéder aux chapitres premium.");return}C(null),n||r?(D(),S(`/lecture/${d}/${s.id}`)):B(E===s.id?null:s.id)},T=()=>g(!0),q=()=>g(!1),D=()=>{document.fullscreenElement||document.documentElement.requestFullscreen().catch(s=>{console.log(`Error attempting to enable fullscreen: ${s.message}`)})};return e.jsxs("div",{className:"page pre-hub-page page--fade",children:[e.jsx("div",{className:"pre-hub",children:e.jsxs("div",{className:"pre-hub__inner",children:[x&&e.jsx("div",{role:"alert",style:{background:"rgba(248,113,113,0.12)",border:"1px solid rgba(248,113,113,0.5)",color:"#fecaca",padding:"12px 16px",borderRadius:"10px",marginBottom:"16px"},children:x}),e.jsx("div",{className:"pre-hub__hero",children:e.jsxs("div",{className:"pre-hub__hero-grid",children:[e.jsx("div",{className:"pre-hub__media",children:e.jsx("div",{className:"pre-hub__poster",children:e.jsx("img",{src:P,alt:I,loading:"eager",onError:s=>{s.target.src="https://placehold.co/600x900/1a1a1a/ffffff?text=No+Cover"}})})}),e.jsxs("div",{className:"pre-hub__hero-text",children:[e.jsx("h1",{className:"pre-hub__novel-title stagger-item delay-2",children:I}),e.jsx("p",{className:"pre-hub__lead stagger-item delay-3",children:H}),_.length>0&&e.jsx(A,{to:`/lecture/${d}/${_[0].id}`,className:"pre-hub__cta stagger-item delay-4",onClick:D,children:"Commencer l'écoute"}),e.jsx("div",{className:"pre-hub__credits-section stagger-item delay-4",children:n?e.jsxs("div",{className:"pre-hub__credits-grid-desktop",children:[i.creative&&i.creative.map((s,r)=>e.jsxs("div",{className:"pre-hub__credit-card-desktop",children:[e.jsx("h3",{className:"pre-hub__credit-head",children:s.title==="Production"?"Illustration":s.title}),e.jsx("ul",{className:"pre-hub__credit-lines",children:s.people.map((a,c)=>e.jsxs("li",{className:"pre-hub__credit-line",children:[e.jsx("span",{className:"pre-hub__credit-name",children:a.name}),e.jsx("span",{className:"pre-hub__credit-role",children:a.role})]},c))})]},r)),e.jsxs("div",{className:"pre-hub__credit-card-desktop",children:[e.jsx("h3",{className:"pre-hub__credit-head",children:"Comédiens"}),e.jsx("ul",{className:"pre-hub__credit-lines",children:i.voices&&i.voices.slice(0,3).map((s,r)=>e.jsxs("li",{className:"pre-hub__credit-line",children:[e.jsx("span",{className:"pre-hub__credit-name",children:s.name}),e.jsx("span",{className:"pre-hub__credit-role",children:s.role})]},r))}),e.jsx("button",{className:"pre-hub__credit-more-link",onClick:T,children:"Voir tous les talents"})]})]}):e.jsxs("div",{className:"pre-hub__credit-stack",onClick:T,children:[e.jsx("div",{className:"pre-hub__credit-stack__head",children:e.jsx("h3",{className:"pre-hub__credit-head",children:"Crédits"})}),e.jsx("ul",{className:"pre-hub__credit-lines",children:i.creative&&i.creative.slice(0,2).map(s=>s.people.map((r,a)=>e.jsxs("li",{className:"pre-hub__credit-line",children:[e.jsx("span",{className:"pre-hub__credit-name",children:r.name}),e.jsx("span",{className:"pre-hub__credit-role",children:r.role})]},`${s.title}-${a}`)))}),e.jsx("div",{className:"pre-hub__credit-more-container",children:e.jsx("span",{className:"pre-hub__credit-more",children:"Afficher plus"})})]})})]})]})}),y&&e.jsx("div",{role:"status",style:{background:"rgba(251,191,36,0.12)",border:"1px solid rgba(251,191,36,0.5)",color:"#facc15",padding:"12px 16px",borderRadius:"10px",margin:"12px 0 0"},children:y}),e.jsx("section",{className:"pre-hub__pane pre-hub__pane--chapters",children:e.jsx("div",{className:"pre-hub__chapter-list",children:K.map(s=>{const r=E===s.id,a=s.is_premium&&!$;let c=s.cover_image||P;return c&&!c.startsWith("http")&&(c=`https://gmunwpptyhwiiffcbhcq.supabase.co/storage/v1/object/public/${c.split("/").map(o=>encodeURIComponent(o)).join("/")}`),e.jsxs("article",{className:`pre-hub__chapter-card pre-hub__chapter-card--list ${r?"expanded":""} ${a?"chapter-locked":""}`,onClick:()=>f(s),children:[e.jsx("div",{className:"pre-hub__chapter-thumb",style:{backgroundImage:`url('${c}')`},onClick:o=>{n||(o.stopPropagation(),f(s,!0))},children:n&&e.jsx("span",{className:"pre-hub__chapter-badge",children:s.chapter_number})}),e.jsxs("div",{className:"pre-hub__chapter-content",children:[e.jsxs("div",{className:"pre-hub__chapter-header-mobile",children:[e.jsxs("div",{className:"pre-hub__chapter-texts",children:[e.jsx("p",{className:"pre-hub__chapter-title",children:s.title}),s.is_premium&&e.jsx("span",{style:{color:"#f59e0b",fontSize:"0.85rem",marginLeft:"8px"},children:"Premium"})]}),!n&&e.jsxs("span",{className:"pre-hub__chapter-badge pre-hub__chapter-badge--mobile",children:["#",s.chapter_number]})]}),e.jsxs("div",{className:`pre-hub__chapter-details ${n||r?"visible":""}`,children:[e.jsx("p",{className:"pre-hub__chapter-desc",children:s.description||"Aucune description disponible."}),!n&&a&&e.jsx("button",{className:"pre-hub__chapter-play-btn",onClick:o=>{o.stopPropagation(),f(s)},style:{backgroundColor:"#f59e0b",color:"#0a0a0a"},children:u?"Acheter":"Connexion requise"})]})]})]},s.id)})})})]})}),p&&Q.createPortal(e.jsx("div",{className:"credits-overlay",onClick:q,children:e.jsxs("div",{className:"credits-overlay__panel",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"credits-overlay__head",children:[e.jsx("h2",{className:"credits-overlay__title",children:"Crédits complets"}),e.jsx("button",{className:"credits-overlay__close",onClick:q,children:"Fermer"})]}),e.jsx("div",{className:"credits-overlay__grid",children:i.creative&&i.creative.map((s,r)=>e.jsxs("div",{className:"credits-overlay__card",children:[e.jsx("h3",{className:"credits-overlay__card-title",children:s.title}),e.jsx("ul",{children:s.people.map((a,c)=>e.jsxs("li",{children:[a.name," - ",a.role]},c))})]},r))}),e.jsxs("div",{className:"credits-overlay__voices",children:[e.jsx("h3",{children:"Comédiens"}),e.jsx("ul",{children:i.voices&&i.voices.map((s,r)=>e.jsxs("li",{children:[s.name," - ",s.role]},r))})]})]})}),document.body)]})}export{re as default};
